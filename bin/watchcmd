#!/bin/bash

if [[ $# -lt 2 ]]; then
    echo "Usage $0 WATCHDIR COMMAND"
    echo "This script runs then given command on a change to the specified directory"
    echo ""
    exit 1
fi

WATCHDIR=$1
shift
COMMAND=$@
JOBPID=()

trap 'cleanup' SIGINT SIGTERM EXIT

function cleanup(){
    for jpid in ${JOBPID[*]}; do
        pkill -KILL -P $jpid 2> /dev/null
    done
}

function runcommand(){
    cleanup
    echo "Running Command $COMMAND"
    $COMMAND &
    JOBPID+=($!)
}

runcommand &

#the command before the pipe is a blocking command, i.e. it doesn't end
inotifywait -m -r --format '%f' -e close_write $WATCHDIR | while read file; do
    if ( echo $file | grep -E '^(.*\.go)$|^(.*\.js)$|^(.*\.*css)' > /dev/null ); then
        echo "File $file modified"
        runcommand
    fi
done
