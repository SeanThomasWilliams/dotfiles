#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

TOPDIR="$PWD"

if [[ ${DEBUG-} -eq 1 ]]; then
  set -x
fi

# Show certificate info for the given input files or domains
show_cert_bundle_info(){
  local cert_bundle
  cert_bundle="$(realpath "$1")"

  tmp_dir="$(mktemp -d)"
  cd "$tmp_dir"

  awk '/-----BEGIN/,/-----END/{ if(/-----BEGIN/){c++}; out="cert." c ".pem"; print >out}' < "$cert_bundle"

  for cert in "$tmp_dir"/*; do
    show_cert_info "$cert"
  done

  rm -rf "$tmp_dir"

  cd "$OLDPWD"
}

# Decode DER certificate, convert to PEM, and show info
show_der_cert_info(){
  local der_cert
  der_cert="$(realpath "$1")"

  tmp_dir="$(mktemp -d)"
  cd "$tmp_dir"

  openssl x509 -inform der -in "$der_cert" -out cert.pem
  show_cert_info "$tmp_dir/cert.pem"

  rm -rf "$tmp_dir"

  cd "$OLDPWD"
}

# Show certificate info for the given input files or domains
show_cert_info(){
  local cert_file
  cert_file="$1"

  openssl x509 -text -noout -in "$cert_file"

  echo "MD5:"
  openssl x509 -noout -modulus -in "$cert_file" | openssl md5
}

process_by_file_content(){
  local tmpdir tmpfile
  tmpdir=$(mktemp -d)
  trap "rm -rf $tmpdir" EXIT

  tmpfile="$tmpdir/detect.me"
  sed -e 's#\r#\n#g' |\
    sed -e 's/^\s*//' > "$tmpfile"

  if grep -q 'CERTIFICATE----' "$tmpfile"; then
    newcert="$tmpdir/tls.crt"
  elif grep -q 'CERTIFICATE REQUEST' "$tmpfile"; then
    newcert="$tmpdir/tls.csr"
  elif grep -q 'PRIVATE KEY' "$tmpfile"; then
    newcert="$tmpdir/tls.key"
  else
    echo >&2 "Unknown file content from:"
    echo >&2 "$tmpfile"
    exit 1
  fi

  mv "$tmpfile" "$newcert"
  process_by_file_extension "$newcert"
}

process_by_file_extension(){
  local cert
  cert=${1}
  suffix=${cert##*.}
  echo "Information for $cert:"
  case "$suffix" in
    p7b)
      openssl pkcs7 -print_certs -in "$cert"
      ;;
    pfx|p12)
      openssl pkcs12 -info -in "$cert"
      ;;
    der)
      show_der_cert_info "$cert"
      ;;
    pem|crt|cer)
      show_cert_bundle_info "$cert"
      ;;
    key)
      openssl rsa -check -in "$cert"
      echo >&2 "MD5:"
      openssl rsa -noout -modulus -in "$cert" | openssl md5
      ;;
    csr)
      openssl req -text -noout -verify -in "$cert"
      echo >&2 "MD5:"
      openssl req -noout -modulus -in "$cert" | openssl md5
      ;;
    *)
      echo >&2 "Unknown extension: $suffix for $cert"
      exit 1
      ;;
  esac
}

for fname in "$@"; do
  if [[ $fname =~ https://* ]]; then
    tmpdir=$(mktemp -d)

    domain="$(echo "$fname" | cut -d'/' -f3)"
    fname="$tmpdir/${domain}.crt"

    openssl s_client -showcerts \
      -connect "$domain:443" \
      -servername "$domain" </dev/null 2>/dev/null |\
      openssl x509 -outform PEM > "$fname"
  fi

  process_by_file_extension "$fname"
done

if [[ ! -t 0 ]]; then
  process_by_file_content
fi
