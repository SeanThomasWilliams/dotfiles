#!/usr/bin/env bash

set -uo pipefail

if [[ ${DEBUG:-0} -eq 1 ]]; then
  set -x
fi

if [[ -z ${TMUX_DIR_BASES-} ]]; then
  echo >&2 "TMUX_DIR_BASES is not set"
  exit 1
fi

TS_CACHE="$HOME/.ts.cache"
TS_LIST="$TS_CACHE"
FILTER_CACHE='asdf|\.terraform/modules'

FZF_QUERY=""
FZF_PREVIEW_ARGS=()

# If -c is passed, clear the cache
if [[ "$#" -ge 1 && "$1" == "-r" ]]; then
  rm -f "$TS_CACHE"
  shift
fi

if [[ "$#" -ge 1 && "$1" == "-a" ]]; then
  TS_LIST="/tmp/.ts.active"
  tmux list-sessions -F "#{session_name}" > "$TS_LIST"
  FZF_PREVIEW_ARGS=(
    --preview 'tmux capture-pane -J -p -e -t {}'
    --preview-window 'down:80%'
  )
  shift
fi

if [[ $# -eq 1 ]]; then
  FZF_QUERY="$1"
fi

# Create the cache file if it doesn't exist
if [[ ! -f "$TS_CACHE" ]]; then
  { find $TMUX_DIR_BASES -type d -name '.git'; find $TMUX_DIR_BASES -type f -name '.git' -exec grep -l -v '/modules/' {} +; } 2>/dev/null |\
    grep -Ev "$FILTER_CACHE" |\
    sed 's#/.git$##' > "$TS_CACHE"
fi

selected=$(fzf --select-1 --query="${FZF_QUERY-}" "${FZF_PREVIEW_ARGS[@]}" < "$TS_LIST")
if [[ -z $selected ]]; then
  exit 0
fi

selected_name=$(echo "$selected" |\
  sed "s#$HOME/##;s#.*\.com/##" |\
  awk -F'/' 'BEGIN{OFS="/"} {gsub(/\./, "_", $0)} NF >= 3 {print substr($1, 1, 4),$(NF-1),$NF}; NF < 3 {print $(NF-1),$NF}')
tmux_running=$(pgrep tmux)

# Brand new tmux / session
if [[ -z ${TMUX-} && -z ${tmux_running-} ]]; then
  tmux new-session -s $selected_name -c $selected
  exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
  tmux new-session -ds $selected_name -c $selected
fi

if [[ -z ${TMUX-} ]]; then
  tmux attach -t $selected_name
else
  tmux switch-client -t $selected_name
fi
