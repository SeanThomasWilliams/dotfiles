#!/bin/bash

set -eu
set -o pipefail

if [[ -n ${DEBUG-} ]]; then
  set -x
fi

# Card Names
BLUEZ_CARD_NAME="bluez_card.38_18_4C_06_51_52"
PCI_CARD_NAME="alsa_card.pci-0000_00_1f.3"

# Card Profiles
ANALOG_DUPLEX_PROFILE="output:analog-stereo+input:analog-stereo"
HDMI_PROFILE="output:hdmi-stereo-extra1"
LOFI_PROFILE="handsfree_head_unit"
HIFI_PROFILE="a2dp_sink"

# Input Ports
HEADSET_MIC_PORT="analog-input-headset-mic"

# Handle Bluetooth headset toggle
handle_bluetooth_headset(){
  if pactl list short sinks | grep -q bluez; then
    if pacmd list-cards | grep -q "active profile: <$HIFI_PROFILE>"; then
      echo >&2 "Switching to LoFi Profile"
      pactl set-card-profile "$BLUEZ_CARD_NAME" "$LOFI_PROFILE"
    else
      echo >&2 "Switching to HiFi Profile"
      pactl set-card-profile "$BLUEZ_CARD_NAME" "$HIFI_PROFILE"
    fi

    exit
  fi
}

activate_analog_mic(){
  pactl list sources |\
    awk '
      /not avail/ {next;}
      /Name:/ {mic_source=$2; next;}
      /analog-input-mic.*avail/ {sub(":",""); mic=$1; next;}
      /analog-input-headset-mic.*avail/ {sub(":",""); headset_mic=$1; next;}
      END {
        if (mic_source){
          system("pactl set-source-mute " mic_source " false");
        }
        if (headset_mic) {
          system("pactl set-source-port " mic_source " " headset_mic);
          exit;
        }
        if (mic) {
          system("pactl set-source-port " mic_source " " mic);
          exit;
        }
        exit 1;
      }'
}

handle_analog_headset(){
  ACTIVE_CARD_PROFILE=$(pactl list cards |\
    awk '
      /Name: / {
        name=$2;
      }
      /Active Profile/ && name ~ /pci/ {
        print $3;
      }
    ')

  if [[ "$ACTIVE_CARD_PROFILE" =~ $ANALOG_DUPLEX_PROFILE || "$ACTIVE_CARD_PROFILE" == "$ANALOG_DUPLEX_PROFILE" ]]; then
    echo >&2 "Toggle HDMI profile"
    pactl set-card-profile "$PCI_CARD_NAME" "$HDMI_PROFILE"
  elif [[ $ACTIVE_CARD_PROFILE =~ $HDMI_PROFILE || "$ACTIVE_CARD_PROFILE" == "$HDMI_PROFILE" ]]; then
    echo >&2 "Toggle Headset profile"
    pactl set-card-profile "$PCI_CARD_NAME" "$ANALOG_DUPLEX_PROFILE"

    echo >&2 "Check if headset is plugged in"
    HEADSET_OUTPUT=$(pactl list sinks |\
      awk '/analog-output-headphones.*avail/ && ! /not/ {sub(":",""); print $1; exit;}')

    if [[ -n ${HEADSET_OUTPUT-} ]]; then
      echo >&2 "Headset is plugged in!"
      PCI_SINK=$(pactl list short sinks | awk '/alsa_output.pci-/ {print $2}')
      pactl set-sink-port "$PCI_SINK" "$HEADSET_OUTPUT"
    else
      echo >&2 "Headset is not plugged in"
    fi

    echo >&2 "Activating analog mic"
    activate_analog_mic
  else # No active profile
    echo >&2 "No active profile found!"
    echo -e >&2 "\nCurrent: $ACTIVE_CARD_PROFILE\nHDMI: $HDMI_PROFILE\nAnalog: $ANALOG_DUPLEX_PROFILE"
    exit 1
  fi
}

handle_bluetooth_headset
handle_analog_headset
