#!/bin/bash

# Workaround
__vte_prompt_command() { true; }

load_session_manager_settings(){
  ### session managers
  screenreattach(){
    if [[ $1 == "ls" ]]; then
      tmux list-sessions
    else
      tmux -u -2 new -A -s "${1:-tmux}"
    fi
  }
  export -f screenreattach
  alias sr="screenreattach"

  # custom session manager settings
  alias htop="TERM=screen htop"

  # check the window size after each command and, if necessary, update the values of LINES and COLUMNS.
  shopt -s checkwinsize

  # term settings
  export TERM="${TERM:-screen-256color}"
  export TMUX_TMPDIR="$HOME/.local"
}

load_editor_settings(){
  ### 'vim' settings
  export EDITOR="vim"
  if command -v nvim > /dev/null; then
    export EDITOR="nvim"
    alias vimdiff="nvim -d"
  fi

  export GIT_EDITOR="$EDITOR"
  alias vim="$EDITOR"
  alias vi="$EDITOR"

  export PAGER="less"
  export LESS="-FRSX"

  vimdirdiff(){
    $EDITOR -c "DirDiff $1 $2"
  }
  export -f vimdirdiff
}

load_python_settings(){
  # Skip writing pyc and __pycache__
  export PYTHONDONTWRITEBYTECODE=1
}

load_golang_settings(){
  export GO111MODULE=on
}

load_history_settings(){
  ### history
  shopt -s histappend              # append new history items to .bash_history
  export HISTCONTROL=ignorespace   # leading space hides commands from history
  export HISTFILESIZE=10000        # increase history file size (default is 500)
  export HISTSIZE=${HISTFILESIZE}  # increase history size (default is 500)
  export PROMPT_COMMAND="history -a; history -n; ${PROMPT_COMMAND}"

  # HSTR configuration
  if command -V hstr &> /dev/null; then
    alias hh=hstr                    # hh to be alias for hstr
    export HSTR_CONFIG=hicolor       # get more colors

    # if this is interactive shell, then bind hstr to Ctrl-r (for Vi mode check doc)
    if [[ $- =~ .*i.* ]]; then
      bind '"\C-r": "\C-a hstr -- \C-j"'
    fi
    # if this is interactive shell, then bind 'kill last command' to Ctrl-x k
    if [[ $- =~ .*i.* ]]; then
      bind '"\C-xk": "\C-a hstr -k \C-j"'
    fi
  fi
}

load_lang_settings(){
  # LANG
  export LANG=en_us.UTF-8
  export LC_ALL=en_US.UTF-8
  export LC_COLLATE="en_US.UTF-8"
  export LC_CTYPE="en_US.UTF-8"
  export LC_MESSAGES="en_US.UTF-8"
  export LC_MONETARY="en_US.UTF-8"
  export LC_NUMERIC="en_US.UTF-8"
  export LC_TIME="en_US.UTF-8"
}

load_path_settings(){
  # go
  export GOROOT="$HOME/software/go"
  export GOPATH="$HOME/gocode"
  export GOBIN="$GOPATH/bin"

  # Global PATH, libs, tools
  export PATH="$HOME/bin:$HOME/.local/bin:$HOME/.npm-packages/bin:$HOME/anaconda3/bin:$HOME/bin/Sencha/Cmd:$JAVA_HOME/bin:/usr/local/bin:$GOROOT/bin:$GOBIN:$PATH"

  # Shorten prompt
  export PROMPT_DIRTRIM=3

  # java settings
  if [[ -d /etc/alternatives/java_sdk ]]; then
      export JAVA_HOME="/etc/alternatives/java_sdk"
  fi
}

load_alias_settings(){
  ### alias
  alias ansible-lint="ansible-lint -c $HOME/.ansible-lint"
  alias c="column -t -n -s ',' | less -S -R"
  alias dstat-all='dstat -larm --top-io --top-latency'

  if command -v ag > /dev/null; then
    alias fgrep="ag --ignore export"
    export FZF_DEFAULT_COMMAND='ag --hidden --ignore .git -g ""'
  else
    alias fgrep="find . -type f | awk '!/CVS|\.class|\.jar|\.war|\.git|\.svn|_Stub|\.#/  {print \$0;}' | sed 's/\ /\\\ /g' | xargs grep --color=always -n "
  fi

  ## os-specific
  if ls --color &> /dev/null; then
    # We are on linux
    alias ls="ls -lh --color"
  else
    # Mac OS settings
    alias ls="ls -lh -G"
    alias timeout="gtimeout"
  fi

  # clipboard copy/paste
  if command -v xclip > /dev/null; then
    alias pbcopy='xclip -selection clipboard'
    alias pbpaste='xclip -selection clipboard -o'
  fi

  alias pgpsql="psql -U postgres"

  # Autoenable direnv
  which direnv &> /dev/null && eval "$(direnv hook bash)"
}

load_extra_source_files(){
  ### source workstation-specific
  SOURCEFILES="
  $HOME/.local.alias
  $HOME/anaconda3/etc/profile.d/conda.sh
  /usr/local/etc/profile.d/autojump.sh
  /usr/share/autojump/autojump.bash
  "

  for sf in $SOURCEFILES; do
    if [[ -f $sf ]]; then
      source "$sf"
    fi
  done
}

load_path_settings
load_session_manager_settings
load_python_settings
load_golang_settings
load_editor_settings
load_history_settings
load_lang_settings
load_alias_settings
load_extra_source_files
